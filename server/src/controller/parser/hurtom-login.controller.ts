import { IExpressRequest, IExpressResponse, app } from '@server/express-app';
import axios from 'axios';
import { API_URL } from '@server/constants/api-url.constant';
import { IQueryReturn, toQuery } from '@server/utils/to-query.util';
import { rejects } from 'assert';
import { HURTOM_HEADERS } from './hurtom-all.controller';

const cheerio = require('cheerio');

export interface IHurtomLoginResponse {
    status: string;
    cookie: string;
}

interface IRequest extends IExpressRequest {
   
}

interface IResponse extends IExpressResponse<IHurtomLoginResponse, void> {}

app.post(API_URL.api.parser.hurtomLogin.toString(), async (req: IRequest, res: IResponse) => {
    const [data, error] = await hurtomLoginAsync();
    if (error) {
        return res.status(400).send(error);
    }
    return res.send(data);
});

export const hurtomLoginAsync = async (): Promise<IQueryReturn<IHurtomLoginResponse>> => {
    // mgerasika@gmail.com
    // o4jbfv30
    const url = `https://toloka.to/login.php`;
    const fd = new FormData();
    fd.append('username', 'mgerasika@gmail.com');
    fd.append('password', 'o4jbfv30');
    fd.append('autologin', 'on');
    fd.append('ssl', 'on');
    fd.append('redirect', 'index.php?');
    fd.append('login', 'Вхід');
    const [response, error] = await toQuery(() => axios.post(url, fd, {headers: HURTOM_HEADERS,  withCredentials: true,}, ));
    if (error) {
        return [undefined, error];
    }
    const cookies = response?.headers['set-cookie'] || [];
    return [
        {
            status: response?.statusText || '',
            cookie: 'toloka_318894_f=a%3A0%3A%7B%7D; toloka___f=a%3A0%3A%7B%7D; toloka___uf=0; toloka___u=a%3A0%3A%7B%7D; toloka_318894_uf=1729277947; toloka___tt=1736602709; toloka_ssl=1; toloka_sid=f13ebd68c9da6549f277c79dd71d15ca; toloka_data=a%3A2%3A%7Bs%3A11%3A%22autologinid%22%3Bs%3A32%3A%22e41525216c36108b8f8855361fde6133%22%3Bs%3A6%3A%22userid%22%3Bi%3A318894%3B%7D; toloka_318894_tt=1736669163; toloka_318894_u=a%3A141%3A%7Bi%3A682099%3Bi%3A0%3Bi%3A681462%3Bi%3A0%3Bi%3A682201%3Bi%3A0%3Bi%3A682049%3Bi%3A0%3Bi%3A68689%3Bi%3A0%3Bi%3A651409%3Bi%3A0%3Bi%3A72320%3Bi%3A0%3Bi%3A666969%3Bi%3A0%3Bi%3A679532%3Bi%3A0%3Bi%3A682192%3Bi%3A0%3Bi%3A681900%3Bi%3A0%3Bi%3A682200%3Bi%3A0%3Bi%3A42182%3Bi%3A0%3Bi%3A681742%3Bi%3A0%3Bi%3A113189%3Bi%3A0%3Bi%3A682081%3Bi%3A0%3Bi%3A682075%3Bi%3A6255%3Bi%3A67558%3Bi%3A6255%3Bi%3A677380%3Bi%3A6255%3Bi%3A682213%3Bi%3A6255%3Bi%3A663617%3Bi%3A6255%3Bi%3A682032%3Bi%3A6255%3Bi%3A586263%3Bi%3A6255%3Bi%3A682097%3Bi%3A6255%3Bi%3A680534%3Bi%3A6255%3Bi%3A129586%3Bi%3A6255%3Bi%3A682218%3Bi%3A6255%3Bi%3A680678%3Bi%3A6255%3Bi%3A113916%3Bi%3A6255%3Bi%3A667846%3Bi%3A6255%3Bi%3A682217%3Bi%3A6255%3Bi%3A682211%3Bi%3A6255%3Bi%3A681774%3Bi%3A6255%3Bi%3A682215%3Bi%3A6255%3Bi%3A680718%3Bi%3A6255%3Bi%3A682053%3Bi%3A6255%3Bi%3A6081%3Bi%3A6255%3Bi%3A680450%3Bi%3A6255%3Bi%3A681927%3Bi%3A6255%3Bi%3A378999%3Bi%3A6255%3Bi%3A682207%3Bi%3A6255%3Bi%3A682174%3Bi%3A6255%3Bi%3A682190%3Bi%3A6255%3Bi%3A682208%3Bi%3A6255%3Bi%3A682195%3Bi%3A6255%3Bi%3A378695%3Bi%3A7324383%3Bi%3A112420%3Bi%3A7324383%3Bi%3A684471%3Bi%3A7324957%3Bi%3A680717%3Bi%3A7324957%3Bi%3A684445%3Bi%3A7325349%3Bi%3A681263%3Bi%3A7325349%3Bi%3A684099%3Bi%3A7325349%3Bi%3A684438%3Bi%3A7325349%3Bi%3A682154%3Bi%3A7325349%3Bi%3A684421%3Bi%3A7325349%3Bi%3A682082%3Bi%3A7325349%3Bi%3A662701%3Bi%3A7325349%3Bi%3A681308%3Bi%3A7325349%3Bi%3A110777%3Bi%3A7325349%3Bi%3A658720%3Bi%3A7325349%3Bi%3A115161%3Bi%3A7325349%3Bi%3A67387%3Bi%3A7325349%3Bi%3A684472%3Bi%3A7325349%3Bi%3A26400%3Bi%3A7325349%3Bi%3A683122%3Bi%3A7325349%3Bi%3A684427%3Bi%3A7325349%3Bi%3A684473%3Bi%3A7325349%3Bi%3A656737%3Bi%3A7325349%3Bi%3A125819%3Bi%3A7325349%3Bi%3A674156%3Bi%3A7325349%3Bi%3A683336%3Bi%3A7325349%3Bi%3A84309%3Bi%3A7325349%3Bi%3A109829%3Bi%3A7325349%3Bi%3A684492%3Bi%3A7325349%3Bi%3A684431%3Bi%3A7325349%3Bi%3A113498%3Bi%3A7325349%3Bi%3A670407%3Bi%3A7325349%3Bi%3A682179%3Bi%3A7325349%3Bi%3A681968%3Bi%3A7325349%3Bi%3A684491%3Bi%3A7325349%3Bi%3A683736%3Bi%3A7325349%3Bi%3A660243%3Bi%3A7325349%3Bi%3A684489%3Bi%3A7325349%3Bi%3A684245%3Bi%3A7325349%3Bi%3A684487%3Bi%3A7325349%3Bi%3A684490%3Bi%3A7325349%3Bi%3A684403%3Bi%3A7325349%3Bi%3A588568%3Bi%3A7325349%3Bi%3A684476%3Bi%3A7325349%3Bi%3A684493%3Bi%3A7325349%3Bi%3A668087%3Bi%3A7325349%3Bi%3A684272%3Bi%3A7325349%3Bi%3A684255%3Bi%3A7325349%3Bi%3A684388%3Bi%3A7325349%3Bi%3A684494%3Bi%3A7325349%3Bi%3A75977%3Bi%3A7325349%3Bi%3A101624%3Bi%3A7325349%3Bi%3A684485%3Bi%3A7325349%3Bi%3A684356%3Bi%3A7325349%3Bi%3A31108%3Bi%3A7325349%3Bi%3A684474%3Bi%3A7325349%3Bi%3A684329%3Bi%3A7325349%3Bi%3A684253%3Bi%3A7325349%3Bi%3A480258%3Bi%3A7325349%3Bi%3A114217%3Bi%3A7325349%3Bi%3A684488%3Bi%3A7325349%3Bi%3A127737%3Bi%3A7325349%3Bi%3A684486%3Bi%3A7325349%3Bi%3A684479%3Bi%3A7325349%3Bi%3A102992%3Bi%3A7325349%3Bi%3A684439%3Bi%3A7325349%3Bi%3A130788%3Bi%3A7325349%3Bi%3A673716%3Bi%3A7325349%3Bi%3A684093%3Bi%3A7325349%3Bi%3A684481%3Bi%3A7325349%3Bi%3A684478%3Bi%3A7325349%3Bi%3A684105%3Bi%3A7325349%3Bi%3A682334%3Bi%3A7325349%3Bi%3A684477%3Bi%3A7325349%3Bi%3A684424%3Bi%3A7325349%3Bi%3A684125%3Bi%3A7325349%3Bi%3A683990%3Bi%3A7325349%3Bi%3A675827%3Bi%3A7325349%3Bi%3A664282%3Bi%3A7325349%3Bi%3A86152%3Bi%3A7325349%3Bi%3A684483%3Bi%3A7325349%3Bi%3A683953%3Bi%3A7325349%3Bi%3A657076%3Bi%3A7325349%3Bi%3A655821%3Bi%3A7325349%3Bi%3A200181%3Bi%3A7325349%3Bi%3A13405%3Bi%3A7325349%3Bi%3A684484%3Bi%3A7325349%3Bi%3A683999%3Bi%3A7325349%3Bi%3A684480%3Bi%3A7325349%3Bi%3A677441%3Bi%3A7325349%3Bi%3A679275%3Bi%3A7325349%3Bi%3A673774%3Bi%3A7325349%3Bi%3A684475%3Bi%3A7325349%3Bi%3A684482%3Bi%3A7325349%3Bi%3A680176%3Bi%3A7325349%3Bi%3A672596%3Bi%3A7325349%3B%7D'
        },
    ];
};
